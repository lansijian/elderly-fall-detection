<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è·Œå€’æ£€æµ‹å®æ—¶å¯è§†åŒ–ç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            overflow: hidden;
        }

        .container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: white;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 20px;
            text-align: center;
            flex-shrink: 0;
        }

        .header h1 {
            font-size: 1.5em;
            margin-bottom: 2px;
        }

        .header p {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 10px;
            overflow: hidden;
        }

        .top-section {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-shrink: 0;
        }

        .control-panel {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            flex: 1;
        }

        .control-panel h3 {
            margin-bottom: 8px;
            color: #333;
            font-size: 1em;
        }

        .dataset-selector {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 8px;
        }

        select, button {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
        }

        select:focus, button:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }

        button:hover {
            background: #5a6fd8;
        }

        .playback-controls {
            display: flex;
            gap: 6px;
            align-items: center;
            margin-bottom: 8px;
        }

        .slider-container {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        input[type="range"] {
            flex: 1;
            height: 3px;
        }

        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }

        .status-display {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            flex: 1;
        }

        .status-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 8px;
            text-align: center;
            transition: all 0.3s ease;
            height: 90px; /* å›ºå®šé«˜åº¦ */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .status-card.active {
            border-color: #28a745;
            box-shadow: 0 2px 6px rgba(40, 167, 69, 0.2);
        }

        .status-card.warning {
            border-color: #ffc107;
            box-shadow: 0 2px 6px rgba(255, 193, 7, 0.2);
        }

        .status-card.danger {
            border-color: #dc3545;
            box-shadow: 0 2px 6px rgba(220, 53, 69, 0.2);
        }

        .status-card.motion {
            border-color: #6f42c1;
            box-shadow: 0 2px 6px rgba(111, 66, 193, 0.2);
        }

        .status-title {
            font-size: 0.8em;
            font-weight: bold;
            color: #666;
        }

        .status-value {
            font-size: 1.2em;
            font-weight: bold;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2; /* é™åˆ¶è¡Œæ•° */
            line-clamp: 2; /* æ ‡å‡†å±æ€§ */
            -webkit-box-orient: vertical;
            max-height: 50px; /* æœ€å¤§é«˜åº¦ */
        }

        .status-unit {
            font-size: 0.7em;
            color: #666;
        }

        .charts-section {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            overflow: hidden;
        }

        .chart-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 10px;
            display: flex;
            flex-direction: column;
        }

        .chart-title {
            font-size: 0.9em;
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
            text-align: center;
        }

        .chart-container {
            flex: 1;
            position: relative;
            min-height: 150px;
        }

        .info-panel {
            background: #f8f9fa;
            padding: 8px;
            border-radius: 6px;
            margin-bottom: 8px;
            height: 70px; /* å›ºå®šé«˜åº¦ */
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
            height: 100%;
        }

        .info-item {
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            height: 100%;
        }

        .info-label {
            font-size: 0.7em;
            color: #666;
            margin-bottom: 2px;
        }

        .info-value {
            font-size: 0.9em;
            font-weight: bold;
            color: #333;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 8px;
            font-size: 0.8em;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1400px) {
            .status-display {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 1000px) {
            .status-display {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .speed-controls {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-top: 8px;
        }
        
        #speed-select {
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¥ è·Œå€’æ£€æµ‹å®æ—¶å¯è§†åŒ–ç³»ç»Ÿ</h1>
            <p>åŸºäºä¼ æ„Ÿå™¨æ•°æ®çš„æ™ºèƒ½è·Œå€’æ£€æµ‹ä¸çŠ¶æ€ç›‘æ§</p>
        </div>

        <div class="main-content">
            <!-- ä¿¡æ¯é¢æ¿ -->
            <div class="info-panel" id="info-panel" style="display: none;">
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">æ€»å¸§æ•°</div>
                        <div class="info-value" id="total-frames-info">0</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">é‡‡æ ·ç‡</div>
                        <div class="info-value" id="sample-rate-info">100 Hz</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">æ€»æ—¶é•¿</div>
                        <div class="info-value" id="duration-info">0.00s</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">å½“å‰çŠ¶æ€</div>
                        <div class="info-value" id="current-state-info">æœªåŠ è½½</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">å‚ä¸è€…ID</div>
                        <div class="info-value" id="participant-id-info">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">ä»»åŠ¡ID</div>
                        <div class="info-value" id="task-id-info">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">è¯•éªŒID</div>
                        <div class="info-value" id="trial-id-info">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">æ´»åŠ¨ç±»å‹</div>
                        <div class="info-value" id="activity-type-info">-</div>
                    </div>
                </div>
            </div>

            <!-- é¡¶éƒ¨åŒºåŸŸï¼šæ§åˆ¶é¢æ¿ + çŠ¶æ€æ˜¾ç¤º -->
            <div class="top-section">
                <!-- æ§åˆ¶é¢æ¿ -->
                <div class="control-panel">
                    <h3>ğŸ® æ§åˆ¶é¢æ¿</h3>
                    
                    <div class="dataset-selector">
                        <label for="dataset-select">æ•°æ®é›†:</label>
                        <select id="dataset-select">
                            <option value="">è¯·é€‰æ‹©...</option>
                        </select>
                        <button onclick="loadDataset()">åŠ è½½</button>
                    </div>

                    <div class="playback-controls">
                        <button id="play-btn" onclick="playPause()">â–¶ï¸ æ’­æ”¾</button>
                        <button id="stop-btn" onclick="stopPlayback()">â¹ï¸ åœæ­¢</button>
                        <button id="reset-btn" onclick="resetPlayback()">ğŸ”„ é‡ç½®</button>
                        
                        <div class="slider-container">
                            <span id="current-frame">0</span>
                            <input type="range" id="frame-slider" min="0" max="100" value="0">
                            <span id="total-frames">0</span>
                        </div>
                        
                        <span id="current-time">0.00s</span>
                    </div>
                    
                    <div class="speed-controls">
                        <label for="speed-select">æ’­æ”¾é€Ÿåº¦:</label>
                        <select id="speed-select" onchange="changePlaybackSpeed()">
                            <option value="0.5">0.5x</option>
                            <option value="1" selected>1x</option>
                            <option value="2">2x</option>
                            <option value="5">5x</option>
                            <option value="10">10x</option>
                            <option value="20">20x</option>
                            <option value="50">50x</option>
                            <option value="100">100x</option>
                            <option value="200">200x</option>
                            <option value="500">500x</option>
                        </select>
                    </div>
                </div>

                <!-- çŠ¶æ€æ˜¾ç¤º -->
                <div class="status-display" id="status-display" style="display: none;">
                    <div class="status-card" id="acceleration-card">
                        <div class="status-title">åŠ é€Ÿåº¦åˆæˆå€¼</div>
                        <div class="status-value" id="acc-magnitude">0.00</div>
                        <div class="status-unit">m/sÂ²</div>
                    </div>
                    
                    <div class="status-card" id="gyroscope-card">
                        <div class="status-title">é™€èºä»ªåˆæˆå€¼</div>
                        <div class="status-value" id="gyr-magnitude">0.00</div>
                        <div class="status-unit">rad/s</div>
                    </div>
                    
                    <div class="status-card" id="prediction-card">
                        <div class="status-title">è·Œå€’æ£€æµ‹</div>
                        <div class="status-value" id="predicted-state">æ­£å¸¸</div>
                        <div class="status-unit">ç½®ä¿¡åº¦: <span id="confidence">0.00</span></div>
                    </div>
                    
                    <div class="status-card" id="motion-card">
                        <div class="status-title">è¿åŠ¨çŠ¶æ€</div>
                        <div class="status-value" id="motion-state">é™æ­¢</div>
                        <div class="status-unit">ç½®ä¿¡åº¦: <span id="motion-confidence">0.00</span></div>
                    </div>
                    
                    <div class="status-card" id="true-label-card">
                        <div class="status-title">çœŸå®æ ‡ç­¾</div>
                        <div class="status-value" id="true-label">0</div>
                        <div class="status-unit">0=æ­£å¸¸, 1=è·Œå€’</div>
                    </div>
                    
                    <div class="status-card" id="fall-description-card" style="grid-column: 1 / -1;">
                        <div class="status-title">è·Œå€’æè¿°</div>
                        <div class="status-value" id="fall-description" style="overflow: auto; white-space: normal; text-overflow: initial; -webkit-line-clamp: initial; line-clamp: initial; max-height: 60px;">-</div>
                        <div class="status-unit">è·Œå€’è¯¦æƒ…</div>
                    </div>
                </div>
            </div>

            <!-- å›¾è¡¨åŒºåŸŸ -->
            <div class="charts-section" id="charts-container" style="display: none;">
                <div class="chart-card">
                    <div class="chart-title">åŠ é€Ÿåº¦æ•°æ®</div>
                    <div class="chart-container">
                        <canvas id="acceleration-chart"></canvas>
                    </div>
                </div>
                
                <div class="chart-card">
                    <div class="chart-title">é™€èºä»ªæ•°æ®</div>
                    <div class="chart-container">
                        <canvas id="gyroscope-chart"></canvas>
                    </div>
                </div>
                
                <div class="chart-card">
                    <div class="chart-title">æ¬§æ‹‰è§’æ•°æ®</div>
                    <div class="chart-container">
                        <canvas id="euler-chart"></canvas>
                    </div>
                </div>
                
                <div class="chart-card">
                    <div class="chart-title">çŠ¶æ€é¢„æµ‹</div>
                    <div class="chart-container">
                        <canvas id="prediction-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- åŠ è½½æç¤º -->
            <div class="loading" id="loading">
                <h3>è¯·é€‰æ‹©æ•°æ®é›†å¼€å§‹å¯è§†åŒ–</h3>
                <p>ç³»ç»Ÿå°†å®æ—¶æ˜¾ç¤ºä¼ æ„Ÿå™¨æ•°æ®å˜åŒ–å’ŒçŠ¶æ€é¢„æµ‹ç»“æœ</p>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentData = null;
        let currentFrame = 0;
        let isPlaying = false;
        let frameTimer = null; // ç”¨äºæ§åˆ¶å¸§ç‡çš„å®šæ—¶å™¨
        let baseFrameRate = 5; // åŸºç¡€å¸§ç‡(å¸§/ç§’)ï¼Œå¯¹åº”1xé€Ÿåº¦ï¼Œé™ä½åŸºç¡€å¸§ç‡ä½¿é€Ÿåº¦å·®å¼‚æ›´æ˜æ˜¾
        let lastUpdateTime = 0; // ä¸Šæ¬¡æ›´æ–°æ—¶é—´
        let framesToSkip = 0; // é«˜é€Ÿæ’­æ”¾æ—¶éœ€è¦è·³è¿‡çš„å¸§æ•°
        let frameAccumulator = 0; // å¸§ç´¯åŠ å™¨ï¼Œç”¨äºå¤„ç†ä½é€Ÿæ’­æ”¾
        let playbackSpeed = 1; // é»˜è®¤æ’­æ”¾é€Ÿåº¦
        let charts = {};

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadDatasetList();
            initializeCharts();
            
            // æ·»åŠ é”®ç›˜äº‹ä»¶ç›‘å¬
            document.addEventListener('keydown', function(e) {
                if (e.key === ' ' || e.key === 'Spacebar') {
                    playPause(); // ç©ºæ ¼é”®æ§åˆ¶æ’­æ”¾/æš‚åœ
                    e.preventDefault();
                } else if (e.key === 'Escape') {
                    stopPlayback(); // ESCé”®åœæ­¢æ’­æ”¾
                    e.preventDefault();
                }
            });

            // æ»‘å—äº‹ä»¶
            document.getElementById('frame-slider').addEventListener('input', function(e) {
                if (!isPlaying) {
                    currentFrame = parseInt(e.target.value);
                    loadFrameData(currentFrame);
                }
            });
        });

        // åŠ è½½æ•°æ®é›†åˆ—è¡¨
        async function loadDatasetList() {
            try {
                const response = await axios.get('/api/datasets');
                const datasets = response.data;
                
                const select = document.getElementById('dataset-select');
                select.innerHTML = '<option value="">è¯·é€‰æ‹©æ•°æ®é›†...</option>';
                
                datasets.forEach(dataset => {
                    const option = document.createElement('option');
                    option.value = dataset.path;
                    option.textContent = dataset.name;
                    
                    // æ·»åŠ æ•°æ®å±æ€§
                    if (dataset.participant_id !== undefined) {
                        option.dataset.participantId = dataset.participant_id;
                    }
                    if (dataset.activity_type !== undefined) {
                        option.dataset.activityType = dataset.activity_type;
                    }
                    
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('åŠ è½½æ•°æ®é›†åˆ—è¡¨å¤±è´¥:', error);
            }
        }

        // åŠ è½½æ•°æ®é›†
        async function loadDataset() {
            const select = document.getElementById('dataset-select');
            const selectedOption = select.options[select.selectedIndex];
            const filePath = select.value;
            
            if (!filePath) {
                alert('è¯·é€‰æ‹©æ•°æ®é›†');
                return;
            }

            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('status-display').style.display = 'none';
                document.getElementById('charts-container').style.display = 'none';
                document.getElementById('info-panel').style.display = 'none';

                const response = await axios.post('/api/load_data', {
                    file_path: filePath,
                    participant_id: selectedOption.dataset.participantId || null,
                    activity_type: selectedOption.dataset.activityType || null
                });

                if (response.data.success) {
                    currentData = response.data.info;
                    currentFrame = 0;
                    
                    // æ›´æ–°UI
                    document.getElementById('total-frames').textContent = currentData.total_frames;
                    document.getElementById('total-frames-info').textContent = currentData.total_frames;
                    document.getElementById('sample-rate-info').textContent = currentData.sample_rate + ' Hz';
                    document.getElementById('duration-info').textContent = currentData.duration.toFixed(2) + 's';
                    
                    // æ›´æ–°æ»‘å—
                    const slider = document.getElementById('frame-slider');
                    slider.max = currentData.total_frames - 1;
                    slider.value = 0;
                    
                    // æ˜¾ç¤ºé¢æ¿
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('status-display').style.display = 'grid';
                    document.getElementById('charts-container').style.display = 'grid';
                    document.getElementById('info-panel').style.display = 'flex';
                    
                    // åŠ è½½ç¬¬ä¸€å¸§æ•°æ®
                    loadFrameData(0);
                } else {
                    throw new Error(response.data.error);
                }
            } catch (error) {
                console.error('åŠ è½½æ•°æ®é›†å¤±è´¥:', error);
                alert('åŠ è½½æ•°æ®é›†å¤±è´¥: ' + error.message);
                document.getElementById('loading').style.display = 'block';
            }
        }

        // æ’­æ”¾/æš‚åœ
        function playPause() {
            if (!currentData) return;
            
            if (isPlaying) {
                pausePlayback();
            } else {
                startPlayback();
            }
        }

        // å¼€å§‹æ’­æ”¾
        function startPlayback() {
            if (!currentData) return;
            
            console.log("å¼€å§‹æ’­æ”¾ï¼Œå€é€Ÿ:", playbackSpeed);
            isPlaying = true;
            document.getElementById('play-btn').textContent = 'â¸ï¸ æš‚åœ';
            
            // ç¡®ä¿æ¸…é™¤æ‰€æœ‰ç°æœ‰çš„è®¡æ—¶å™¨
            if (frameTimer) {
                clearInterval(frameTimer);
                frameTimer = null;
            }
            
            // è®¡ç®—æ’­æ”¾å‚æ•°
            let interval = 1000 / baseFrameRate; // åŸºç¡€é—´éš”æ—¶é—´(ms)
            
            // å¤„ç†ä¸åŒé€Ÿåº¦èŒƒå›´
            if (playbackSpeed < 1) {
                // ä½é€Ÿæ’­æ”¾ï¼šä¿æŒæ­£å¸¸é—´éš”ï¼Œä½†ä¸æ˜¯æ¯æ¬¡éƒ½æ›´æ–°å¸§
                interval = 200; // å›ºå®š200msçš„æ›´æ–°é¢‘ç‡
                framesToSkip = 0;
            } else if (playbackSpeed <= 10) {
                // æ­£å¸¸åˆ°ä¸­é€Ÿï¼šè°ƒæ•´é—´éš”æ—¶é—´
                interval = Math.max(20, 1000 / (baseFrameRate * playbackSpeed));
                framesToSkip = 0;
            } else {
                // é«˜é€Ÿæ’­æ”¾ï¼šå›ºå®šè¾ƒçŸ­é—´éš”ï¼Œä½†æ¯æ¬¡æ›´æ–°å¤šå¸§
                interval = 20; // å›ºå®š20msçš„é«˜æ›´æ–°é¢‘ç‡
                framesToSkip = Math.floor(playbackSpeed / 10); // æ¯æ¬¡æ›´æ–°è·³è¿‡çš„å¸§æ•°
            }
            
            console.log(`æ’­æ”¾è®¾ç½®: åŸºç¡€å¸§ç‡=${baseFrameRate}å¸§/ç§’, å€é€Ÿ=${playbackSpeed}x, é—´éš”=${interval}ms, è·³å¸§=${framesToSkip}`);
            
            lastUpdateTime = Date.now();
            frameAccumulator = 0;
            
            // ä½¿ç”¨setIntervalä»¥å›ºå®šé—´éš”æ’­æ”¾å¸§
            frameTimer = setInterval(() => {
                if (!isPlaying) {
                    clearInterval(frameTimer);
                    frameTimer = null;
                    return;
                }
                
                const now = Date.now();
                const deltaTime = now - lastUpdateTime;
                lastUpdateTime = now;
                
                // å¯¹äºä½é€Ÿæ’­æ”¾ï¼Œç´¯ç§¯æ—¶é—´ç›´åˆ°è¾¾åˆ°é˜ˆå€¼
                if (playbackSpeed < 1) {
                    frameAccumulator += deltaTime * playbackSpeed;
                    if (frameAccumulator < 100) { // 100msé˜ˆå€¼
                        return; // æœªè¾¾åˆ°æ›´æ–°é˜ˆå€¼ï¼Œè·³è¿‡æ­¤æ¬¡æ›´æ–°
                    }
                    frameAccumulator = 0;
                }
                
                // è®¡ç®—è¿™æ¬¡é—´éš”åº”è¯¥å‰è¿›çš„å¸§æ•°
                let framesToAdvance = 1;
                if (framesToSkip > 0) {
                    framesToAdvance = 1 + framesToSkip;
                }
                
                // å‰è¿›æŒ‡å®šå¸§æ•°
                currentFrame += framesToAdvance;
                if (currentFrame >= currentData.total_frames) {
                    currentFrame = 0; // å¾ªç¯æ’­æ”¾
                }
                
                loadFrameData(currentFrame)
                    .catch(error => {
                        console.error("åŠ è½½å¸§æ•°æ®å¤±è´¥:", error);
                        pausePlayback();
                    });
            }, interval);
        }

        // æš‚åœæ’­æ”¾
        function pausePlayback() {
            console.log("æš‚åœæ’­æ”¾");
            isPlaying = false;
            document.getElementById('play-btn').textContent = 'â–¶ï¸ æ’­æ”¾';
            
            if (frameTimer) {
                clearInterval(frameTimer);
                frameTimer = null;
            }
        }

        // åœæ­¢æ’­æ”¾
        function stopPlayback() {
            console.log("åœæ­¢æ’­æ”¾");
            isPlaying = false;
            document.getElementById('play-btn').textContent = 'â–¶ï¸ æ’­æ”¾';
            
            if (frameTimer) {
                clearInterval(frameTimer);
                frameTimer = null;
            }
            
            currentFrame = 0;
            loadFrameData(currentFrame);
        }

        // é‡ç½®æ’­æ”¾
        function resetPlayback() {
            console.log("é‡ç½®æ’­æ”¾");
            isPlaying = false;
            document.getElementById('play-btn').textContent = 'â–¶ï¸ æ’­æ”¾';
            
            if (frameTimer) {
                clearInterval(frameTimer);
                frameTimer = null;
            }
            
            currentFrame = 0;
            loadFrameData(currentFrame);
            
            // æ¸…ç©ºå›¾è¡¨æ•°æ®
            Object.values(charts).forEach(chart => {
                chart.data.labels = [];
                chart.data.datasets.forEach(dataset => dataset.data = []);
                chart.update();
            });
        }

        // æ¸…é™¤æ‰€æœ‰è®¡æ—¶å™¨
        function clearAllTimers() {
            if (frameTimer) {
                clearInterval(frameTimer);
                frameTimer = null;
            }
        }

        // æ›´æ”¹æ’­æ”¾é€Ÿåº¦
        function changePlaybackSpeed() {
            const speedSelect = document.getElementById('speed-select');
            playbackSpeed = parseFloat(speedSelect.value);
            
            console.log(`æ’­æ”¾é€Ÿåº¦æ›´æ”¹ä¸º: ${playbackSpeed}x`);
            
            // å¦‚æœå½“å‰æ­£åœ¨æ’­æ”¾ï¼Œé‡æ–°å¯åŠ¨æ’­æ”¾ä»¥åº”ç”¨æ–°é€Ÿåº¦
            if (isPlaying) {
                // å…ˆæ¸…é™¤ç°æœ‰çš„è®¡æ—¶å™¨
                if (frameTimer) {
                    clearInterval(frameTimer);
                    frameTimer = null;
                }
                // é‡æ–°å¼€å§‹æ’­æ”¾
                startPlayback();
            }
        }

        // åŠ è½½å¸§æ•°æ® - è¿”å›Promiseä»¥ä¾¿é“¾å¼è°ƒç”¨
        async function loadFrameData(frameId) {
            try {
                const response = await axios.get(`/api/frame_data/${frameId}`);
                const data = response.data;
                
                // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                updateStatusDisplay(data);
                
                // æ›´æ–°å›¾è¡¨
                updateCharts(data);
                
                // æ›´æ–°æ§åˆ¶é¢æ¿
                document.getElementById('current-frame').textContent = frameId;
                document.getElementById('frame-slider').value = frameId;
                document.getElementById('current-time').textContent = data.timestamp.toFixed(2) + 's';
                document.getElementById('current-state-info').textContent = data.predicted_state;
                
                // æ›´æ–°å‚ä¸è€…ä¿¡æ¯
                if (data.participant_id !== undefined) {
                    document.getElementById('participant-id-info').textContent = data.participant_id;
                }
                if (data.task_id !== undefined) {
                    document.getElementById('task-id-info').textContent = data.task_id;
                }
                if (data.trial_id !== undefined) {
                    document.getElementById('trial-id-info').textContent = data.trial_id;
                }
                if (data.activity_type !== undefined) {
                    document.getElementById('activity-type-info').textContent = data.activity_type;
                }
                
                return data;
            } catch (error) {
                console.error('åŠ è½½å¸§æ•°æ®å¤±è´¥:', error);
                throw error;
            }
        }

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatusDisplay(data) {
            // è®¡ç®—åˆæˆå€¼
            const accMagnitude = Math.sqrt(data.AccX**2 + data.AccY**2 + data.AccZ**2);
            const gyrMagnitude = Math.sqrt(data.GyrX**2 + data.GyrY**2 + data.GyrZ**2);
            
            // æ›´æ–°æ˜¾ç¤º
            document.getElementById('acc-magnitude').textContent = accMagnitude.toFixed(2);
            document.getElementById('gyr-magnitude').textContent = gyrMagnitude.toFixed(2);
            document.getElementById('predicted-state').textContent = data.predicted_state;
            document.getElementById('confidence').textContent = (data.confidence * 100).toFixed(1) + '%';
            document.getElementById('motion-state').textContent = data.motion_state;
            document.getElementById('motion-confidence').textContent = (data.motion_confidence * 100).toFixed(1) + '%';
            document.getElementById('true-label').textContent = data.label;
            
            // æ›´æ–°è·Œå€’æè¿°
            if (data.fall_description) {
                const descElement = document.getElementById('fall-description');
                descElement.textContent = data.fall_description;
                descElement.title = data.fall_description; // æ·»åŠ tooltip
                document.getElementById('fall-description-card').style.display = 'flex';
            } else {
                document.getElementById('fall-description').textContent = '-';
                document.getElementById('fall-description').title = ''; // æ¸…é™¤tooltip
                // æ ¹æ®é¢„æµ‹çŠ¶æ€æˆ–çœŸå®æ ‡ç­¾å†³å®šæ˜¯å¦æ˜¾ç¤ºè·Œå€’æè¿°å¡ç‰‡
                if (data.predicted_state === 'è·Œå€’' || data.label === 1 || data.activity_type === 'fall') {
                    document.getElementById('fall-description-card').style.display = 'flex';
                } else {
                    document.getElementById('fall-description-card').style.display = 'none';
                }
            }
            
            // æ›´æ–°çŠ¶æ€å¡ç‰‡æ ·å¼
            updateStatusCardStyle('acceleration-card', accMagnitude, 1.5, 2.0);
            updateStatusCardStyle('gyroscope-card', gyrMagnitude, 1.0, 1.5);
            updateStatusCardStyle('prediction-card', data.confidence, 0.6, 0.8);
            updateMotionCardStyle('motion-card', data.motion_color);
            
            // é«˜äº®æ˜¾ç¤ºè·Œå€’æ ‡ç­¾
            const trueLabelCard = document.getElementById('true-label-card');
            trueLabelCard.className = 'status-card';
            if (data.label === 1) {
                trueLabelCard.classList.add('danger');
                trueLabelCard.style.borderColor = '#dc3545';
                trueLabelCard.style.boxShadow = '0 2px 6px rgba(220, 53, 69, 0.5)';
            } else {
                trueLabelCard.classList.add('active');
            }
        }

        // æ›´æ–°çŠ¶æ€å¡ç‰‡æ ·å¼
        function updateStatusCardStyle(cardId, value, warningThreshold, dangerThreshold) {
            const card = document.getElementById(cardId);
            card.className = 'status-card';
            
            if (value >= dangerThreshold) {
                card.classList.add('danger');
            } else if (value >= warningThreshold) {
                card.classList.add('warning');
            } else {
                card.classList.add('active');
            }
        }

        // æ›´æ–°è¿åŠ¨çŠ¶æ€å¡ç‰‡æ ·å¼
        function updateMotionCardStyle(cardId, color) {
            const card = document.getElementById(cardId);
            card.className = 'status-card motion';
            card.style.borderColor = color;
            card.style.boxShadow = `0 2px 6px ${color}40`;
        }

        // åˆå§‹åŒ–å›¾è¡¨
        function initializeCharts() {
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    duration: 100
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: 'æ—¶é—´ (s)',
                            font: { size: 8 }
                        },
                        ticks: { font: { size: 8 } }
                    },
                    y: {
                        display: true,
                        title: {
                            display: true,
                            text: 'æ•°å€¼',
                            font: { size: 8 }
                        },
                        ticks: { font: { size: 8 } }
                    }
                },
                plugins: {
                    legend: {
                        labels: { font: { size: 8 } }
                    }
                }
            };

            // åŠ é€Ÿåº¦å›¾è¡¨
            charts.acceleration = new Chart(
                document.getElementById('acceleration-chart'),
                {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [
                            { label: 'AccX', data: [], borderColor: 'red', backgroundColor: 'rgba(255,0,0,0.1)', borderWidth: 1 },
                            { label: 'AccY', data: [], borderColor: 'green', backgroundColor: 'rgba(0,255,0,0.1)', borderWidth: 1 },
                            { label: 'AccZ', data: [], borderColor: 'blue', backgroundColor: 'rgba(0,0,255,0.1)', borderWidth: 1 }
                        ]
                    },
                    options: chartOptions
                }
            );

            // é™€èºä»ªå›¾è¡¨
            charts.gyroscope = new Chart(
                document.getElementById('gyroscope-chart'),
                {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [
                            { label: 'GyrX', data: [], borderColor: 'orange', backgroundColor: 'rgba(255,165,0,0.1)', borderWidth: 1 },
                            { label: 'GyrY', data: [], borderColor: 'purple', backgroundColor: 'rgba(128,0,128,0.1)', borderWidth: 1 },
                            { label: 'GyrZ', data: [], borderColor: 'brown', backgroundColor: 'rgba(165,42,42,0.1)', borderWidth: 1 }
                        ]
                    },
                    options: chartOptions
                }
            );

            // æ¬§æ‹‰è§’å›¾è¡¨
            charts.euler = new Chart(
                document.getElementById('euler-chart'),
                {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [
                            { label: 'EulerX', data: [], borderColor: 'pink', backgroundColor: 'rgba(255,192,203,0.1)', borderWidth: 1 },
                            { label: 'EulerY', data: [], borderColor: 'cyan', backgroundColor: 'rgba(0,255,255,0.1)', borderWidth: 1 },
                            { label: 'EulerZ', data: [], borderColor: 'lime', backgroundColor: 'rgba(0,255,0,0.1)', borderWidth: 1 }
                        ]
                    },
                    options: chartOptions
                }
            );

            // é¢„æµ‹å›¾è¡¨
            charts.prediction = new Chart(
                document.getElementById('prediction-chart'),
                {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [
                            { label: 'ç½®ä¿¡åº¦', data: [], borderColor: 'black', backgroundColor: 'rgba(0,0,0,0.1)', borderWidth: 2 },
                            { label: 'çœŸå®æ ‡ç­¾', data: [], borderColor: 'gray', backgroundColor: 'rgba(128,128,128,0.1)', borderWidth: 1 }
                        ]
                    },
                    options: chartOptions
                }
            );
        }

        // æ›´æ–°å›¾è¡¨
        function updateCharts(data) {
            const timestamp = data.timestamp;
            
            // æ›´æ–°åŠ é€Ÿåº¦å›¾è¡¨
            charts.acceleration.data.labels.push(timestamp.toFixed(2));
            charts.acceleration.data.datasets[0].data.push(data.AccX);
            charts.acceleration.data.datasets[1].data.push(data.AccY);
            charts.acceleration.data.datasets[2].data.push(data.AccZ);
            
            // æ›´æ–°é™€èºä»ªå›¾è¡¨
            charts.gyroscope.data.labels.push(timestamp.toFixed(2));
            charts.gyroscope.data.datasets[0].data.push(data.GyrX);
            charts.gyroscope.data.datasets[1].data.push(data.GyrY);
            charts.gyroscope.data.datasets[2].data.push(data.GyrZ);
            
            // æ›´æ–°æ¬§æ‹‰è§’å›¾è¡¨
            charts.euler.data.labels.push(timestamp.toFixed(2));
            charts.euler.data.datasets[0].data.push(data.EulerX);
            charts.euler.data.datasets[1].data.push(data.EulerY);
            charts.euler.data.datasets[2].data.push(data.EulerZ);
            
            // æ›´æ–°é¢„æµ‹å›¾è¡¨
            charts.prediction.data.labels.push(timestamp.toFixed(2));
            charts.prediction.data.datasets[0].data.push(data.confidence);
            charts.prediction.data.datasets[1].data.push(data.label);
            
            // é™åˆ¶æ•°æ®ç‚¹æ•°é‡ï¼ˆä¿æŒæœ€è¿‘30ä¸ªç‚¹ï¼Œå‡å°‘å†…å­˜ä½¿ç”¨ï¼‰
            const maxPoints = 30;
            if (charts.acceleration.data.labels.length > maxPoints) {
                charts.acceleration.data.labels.shift();
                charts.acceleration.data.datasets.forEach(dataset => dataset.data.shift());
            }
            if (charts.gyroscope.data.labels.length > maxPoints) {
                charts.gyroscope.data.labels.shift();
                charts.gyroscope.data.datasets.forEach(dataset => dataset.data.shift());
            }
            if (charts.euler.data.labels.length > maxPoints) {
                charts.euler.data.labels.shift();
                charts.euler.data.datasets.forEach(dataset => dataset.data.shift());
            }
            if (charts.prediction.data.labels.length > maxPoints) {
                charts.prediction.data.labels.shift();
                charts.prediction.data.datasets.forEach(dataset => dataset.data.shift());
            }
            
            // æ›´æ–°å›¾è¡¨
            charts.acceleration.update('none'); // ç¦ç”¨åŠ¨ç”»æé«˜æ€§èƒ½
            charts.gyroscope.update('none');
            charts.euler.update('none');
            charts.prediction.update('none');
        }
    </script>
</body>
</html>